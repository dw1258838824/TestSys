package com.ruoyi.project.system.api.controller;

import com.ruoyi.common.constant.Anonymous;
import com.ruoyi.framework.configure.StudentSession;
import com.ruoyi.project.system.student.domain.Student;
import com.ruoyi.project.system.student.service.IStudentService;
import com.testsys.common.Cache;
import com.testsys.utils.ApiResult;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletResponse;

@RestController
@RequestMapping("/api/student")
public class StudentApi {

    @Autowired
    private IStudentService studentService;

    @Value("${wechat.domainName}")
    private String domainName;

    @PostMapping("/update")
    @Anonymous
    public ApiResult updateStudentInfo(String key, String phone, HttpServletResponse response){
        String weChatId = Cache.get(key).toString();
        String captcha = Cache.get(phone).toString();
        if(StringUtils.isEmpty(weChatId)){
            return new ApiResult(500,"微信登陆授权信息有误");
        }else if(StringUtils.isEmpty(captcha)){
            return new ApiResult(500,"验证码错误");
        }
        Student student = studentService.selectStudentByMobile(phone);
        if(null == student){
            return new ApiResult(500,"用户不存在");
        }
        student.setWechatId(weChatId);
        studentService.updateWeChatIdByStudent(student);
        Cache.remove(key);
        Cache.remove(phone);
        student = studentService.selectStudentByMobile(phone);
        StudentSession ss = new StudentSession();
        ss.setStudentId(student.getStudentId());
        ss.setWechatId(student.getWechatId());
        ss.createWebToken(domainName,response);
        return new ApiResult(200,"成功");
    }


}
