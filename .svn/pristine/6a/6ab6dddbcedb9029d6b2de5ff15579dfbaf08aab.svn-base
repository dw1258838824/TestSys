package com.testsys.common;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

import com.alibaba.fastjson.JSON;
import com.testsys.utils.HttpUtil;

/**
 * 人脸识别认证（by：百度aip）
 * 
 * @author TestSys
 *
 */
public class FaceRecognitionAuth {

	// 应用APP_ID
	public static final String APP_ID = "20308087";
	// 应用API_KEY
	public static final String API_KEY = "u8OzevSro7akZHKoACTWNfma";
	// 应用SECRET_KEY
	public static final String SECRET_KEY = "eH7LtBg24RFcanreo6IwpdlDXqp80sqN";

	/**
	 * 人脸注册
	 * 
	 * @param groupId     用户组ID
	 * @param userId      用户id
	 * @param imageBase64 用户人脸照片
	 * @param remark      用户描述
	 * @return faceToken 人脸唯一标志码
	 */
	public static String faceSet(String groupId, String userId, String imageBase64, String remark) {
		// 请求url
		String url = "https://aip.baidubce.com/rest/2.0/face/v3/faceset/user/add";
		try {
			Map<String, Object> map = new HashMap<>();
			map.put("group_id", groupId);
			map.put("user_id", userId);
			map.put("image_type", "BASE64");
			map.put("image", imageBase64);
			map.put("user_info", remark);

			String param = JSON.toJSON(map).toString();

			String accessToken = "24.870360e81e463effe78865a887d4bd8b.2592000.1594365685.282335-20308087";

			String result = HttpUtil.post(url, accessToken, "application/json", param);
			Map<String, String> resultMap = (Map) JSON.parse(result);
			String faceToken = resultMap.get("face_token");
			return faceToken;
		} catch (Exception e) {
			e.printStackTrace();
			return "error";
		}
	}

	/**
	 * 人脸比对
	 * 
	 * @param imageBase64 用户人脸照片
	 * @param faceToken   人脸唯一标志码
	 * @return
	 */
	public static String getFaceList(String imageBase64, String faceToken) {
		// 请求url
		String url = "https://aip.baidubce.com/rest/2.0/face/v3/match";
		try {
			Map<String, Object> map1 = new HashMap<>();
			map1.put("image", imageBase64);
			map1.put("image_type", "BASE64");

			Map<String, Object> map2 = new HashMap<>();
			map2.put("image", faceToken);
			map2.put("image_type", "FACE_TOKEN");

			ArrayList<Map> arrayList = new ArrayList<Map>();
			arrayList.add(map2);
			arrayList.add(map2);

			String param = JSON.toJSON(arrayList).toString();

			String accessToken = "24.870360e81e463effe78865a887d4bd8b.2592000.1594365685.282335-20308087";

			String result = HttpUtil.post(url, accessToken, "application/json", param);
			Map<String, String> resultMap = (Map) JSON.parse(result);
			Float score = Float.valueOf(resultMap.get("score"));
			if (score < 80) {
				return "fail";
			}
			return "success";
		} catch (Exception e) {
			e.printStackTrace();
			return "error";
		}

	}

}
