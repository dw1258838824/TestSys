package com.ruoyi.project.system.api.controller;

import com.ruoyi.common.constant.Anonymous;
import com.ruoyi.framework.configure.StudentSession;
import com.ruoyi.project.system.api.entity.WeChatCallBack;
import com.ruoyi.project.system.bill.domain.Bill;
import com.ruoyi.project.system.bill.service.IBillService;
import com.ruoyi.project.system.exam.domain.TExam;
import com.ruoyi.project.system.exam.service.ITExamService;
import com.testsys.utils.ApiResult;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.UUID;

@RestController
@RequestMapping("/api/bill")
public class BillApi {

    @Autowired
    private IBillService billService;
    @Autowired
    private ITExamService examService;

    @GetMapping("/add")
    public ApiResult add(Long examId, HttpServletRequest request){
        StudentSession ss = StudentSession.getStudentSession(request);
        if(null == ss){
            return new ApiResult(500,"未登陆");
        }
        TExam exam = examService.selectTExamById(examId);
        if(null != exam){
            String billNo = UUID.randomUUID().toString().replaceAll("-","").toUpperCase();
            Bill bill = new Bill();
            bill.setBillNo(billNo);//订单编号
            bill.setBillType("2");//账单类型  1收入  2支出
            bill.setBillName("1");//账单名称  1报名费 2补考费
            bill.setPayUserId(new Long("5"));//支付人
            bill.setAmount(exam.getPrice());//价格
            bill.setPayState("0");//交易状态  0处理中 1成功 2异常
            bill.setRefId(examId);//关联编号
            int count = billService.insertBill(bill);
            if(count > 0){
                return new ApiResult("wxid");
            }
        }
        return new ApiResult(500,"失败");
    }

    @GetMapping("/pay/callback")
    public void callBack(WeChatCallBack wccb){
        String state = "SUCCESS";
        //返回支付成功
        Bill bill = new Bill();
        if(state.equals(wccb.getReturn_code())){
            bill.setPayState("1");
            bill.setPayNo(wccb.getTransaction_id());
            bill.setBillNo(wccb.getOut_trade_no());
            billService.updatePayStateByBillNo(bill);
        }else{
            //支付失败

        }
    }
}
