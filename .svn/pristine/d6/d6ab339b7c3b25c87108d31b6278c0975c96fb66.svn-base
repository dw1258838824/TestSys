package com.ruoyi.project.system.api.controller;

import com.ruoyi.common.constant.Anonymous;
import com.ruoyi.project.system.api.entity.WeChatCallBack;
import com.ruoyi.project.system.bill.domain.Bill;
import com.ruoyi.project.system.bill.service.IBillService;
import com.ruoyi.project.system.exam.domain.TExam;
import com.ruoyi.project.system.exam.service.ITExamService;
import com.testsys.utils.ApiResult;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.UUID;

@RestController
@RequestMapping("/api/bill")
public class BillApi {

    @Autowired
    private IBillService billService;
    @Autowired
    private ITExamService examService;

    @GetMapping("/add")
    public ApiResult add(Long examId){
        TExam exam = examService.selectTExamById(examId);
        Bill bill = new Bill();
        bill.setBillNo(UUID.randomUUID().toString());//订单编号
        bill.setBillType("2");//账单类型  1收入  2支出
        bill.setBillName("1");//账单名称  1报名费 2补考费
        bill.setPayUserId(new Long("5"));//支付人
        bill.setAmount(exam.getPrice());//价格
        bill.setPayState("0");//交易状态  0处理中 1成功 2异常
        bill.setRefId(examId);//关联编号
        int count = billService.insertBill(bill);
        if(count > 0){
            return new ApiResult(200,"成功");
        }
        return new ApiResult(500,"失败");
    }

    @GetMapping("/pay/callback")
    @Anonymous
    public void callBack(WeChatCallBack wccb, HttpServletResponse response) throws IOException {
        String state = "SUCCESS";
        //返回支付成功
        if(state.equals(wccb.getReturn_code()) && state.equals(wccb.getResult_code())){

        }else{
            //支付失败

        }
    }

}
